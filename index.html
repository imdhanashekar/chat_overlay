<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <script>
      console.log('API Key:', 'YOUTUBE_API_KEY');
      console.log('Twitch Channel ID:', 'TWITCH_CHANNEL_ID');
      console.log('Twitch OAuth Token:', 'TWITCH_OAUTH_TOKEN');
    </script>
    <link rel="stylesheet" href="assets/styles/main.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nunito:wght@900&display=swap">
    <script>
        const loadParams = new URLSearchParams(window.location.search);
        const pathParts = window.location.pathname.split('/').filter(Boolean);
        const possibleQueryParams = ["handle", "id", "channelId", "value"];

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.src = src;
                script.onload = () => resolve();
                script.onerror = () => reject(new Error(`Falha ao carregar ${src}`));
                document.head.appendChild(script);
            });
        }

        function detectPattern(value) {
            if (typeof value !== "string" || value === null || value === undefined) {
                return null;
            }
            if (value.startsWith("UC") && value.length === 24) {
                return "channelId";
            } else if (value.length === 11 && /^[A-Za-z0-9\-_]+$/.test(value)) {
                return "id";
            } else if (/^[A-Za-z0-9_]+$/.test(value) || value.startsWith("@")) { // Aceita handles sem "@"
                return "handle";
            }
            return null;
        }

        const hasYouTubeParams = (() => {
            for (const paramName of possibleQueryParams) {
                const rawParam = loadParams.get(paramName);
                if (rawParam && detectPattern(rawParam)) {
                    return true;
                }
            }
            for (const part of pathParts) {
                if (detectPattern(part)) {
                    return true;
                }
            }
            return false;
        })();

        const hasTwitchParams = (() => {
            return loadParams.get("twitch") || loadParams.get("channel");
        })();

        const hasKickParams = loadParams.has("kick");

        if (hasYouTubeParams) {
            const detectedParam = pathParts.find(part => detectPattern(part)) ||
                possibleQueryParams.map(p => loadParams.get(p)).find(p => detectPattern(p));
            if (detectedParam) {
                window.youtubeChannelId = detectedParam;
            }
            loadScript("assets/scripts/platforms/youtube.js")
                .then(() => console.log("YouTube script loaded."))
                .catch(err => console.error(err));
        }

        if (hasTwitchParams) {
            const twitchDependencies = [
                "assets/scripts/dependencies/jquery.min.js",
                "assets/scripts/dependencies/irc-message.js",
                "assets/scripts/dependencies/reconnecting-websocket.min.js",
                "assets/scripts/dependencies/twemoji.min.js",
                "assets/scripts/dependencies/tinycolor.js"
            ];
            const twitchMainScript = "assets/scripts/platforms/twitch.js";

            twitchDependencies.reduce((promise, src) => {
                return promise.then(() => loadScript(src));
            }, Promise.resolve())
                .then(() => loadScript(twitchMainScript))
                .then(() => console.log("Twitch scripts loaded."))
                .catch(err => console.error(err));
        }

        if (hasKickParams) {
            loadScript("assets/scripts/platforms/kick.js")
                .then(() => console.log("Kick script loaded."))
                .catch(err => console.error(err));
        }

        if (!hasYouTubeParams && !hasTwitchParams && !hasKickParams) {
            console.log("No scripts loaded.");
        }
    </script>
</head>

<body>
    <div id="chat"></div>
</body>

</html>
